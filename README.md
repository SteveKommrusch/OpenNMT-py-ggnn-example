# OpenNMT-py-ggnn-example

Refer to OpenNMT-py/docs/source/ggnn.md for full example of use of the files in the top-level directory.

## Graph input processing example

The files in the 3 directories 'data', 'src', and 'runs' demonstrate how to use graph data represented textually with parenthesis with GGNN in OpenNMT (i.e., '(root (child1 2 3) (child2 4 5))'). Files in this format can be generate for various computer languages using [ANTLR4](https://www.antlr.org/).

### Step 1: Install OpenNMT-py and related packages
Install `OpenNMT-py` from `pip`:
```bash
pip install OpenNMT-py
```

or from the sources:
```bash
git clone https://github.com/OpenNMT/OpenNMT-py.git
cd OpenNMT-py
# The next step should be done on a CUDA-capable device
python setup.py install
```

Note: If you have MemoryError in the install try to use `pip` with `--no-cache-dir`.

*(Optional)* some advanced features (e.g. working audio, image or pretrained models) requires extra packages, you can install it with:
```bash
pip install -r requirements.opt.txt
```

### Step 2: Install ggnn-example and Environment setup
```bash
# cd to directory above OpenNMT-py
git clone git@github.com:SteveKommrusch/OpenNMT-py-ggnn-example.git
# Review env.sh script and adjust for your installation.
cd OpenNMT-py-ggnn-example
cat env.sh
source env.sh
```

### Step 3: Setup and run seq2seq to generate vocab
```bash
cd data
../src/setupseq2seq.sh antlr_files
cd ../runs/seq2seq
# Activate environment if appopriate on your system: conda activate pytorch
setsid nice -n 19 run.sh > run.nohup.out 2>&1 < /dev/null &

data_path=`/bin/pwd`
./translate12510.sh 50000
cd m50000
for i in 1 2 5 10; do python ../../../src/compare.py --src=pred-test_beam$i.txt --tgt=../tgt-test.txt -v > pass$i.txt; done;
```

### Step 4: Train and use GGNN model
```bash
cd runs/seq2seq
../../src/setupgraph2seq.sh
cd ../graph2seq
setsid nice -n 19 run.sh > run.nohup.out 2>&1 < /dev/null &
./translate12510.sh 10000
cd m10000
for i in 1 2 5 10; do python ../../../src/compare.py --src=pred-test_beam$i.txt --tgt=../tgt-test.txt -v > pass$i.txt; done;
```

### Git file descriptions
 * data/antlr_files/*.txt: Output of [ANTLR4](https://www.antlr.org/) for 10 short programs in C++.
 * src/setupseq2seq.sh: Sets up data files for sequence-to-sequence training in runs/seq2seq. 
 * src/setupgraph2seq.sh: Uses vocab data from sequence-to-sequence run and textual tree data to create OpenNMT GGNN input format.
 * src/raw2graph.pl: PERL script used by setupgraph2seq.sh to generate node, feature, and edge information for OpenNMT GGNN input format.
 * src/compare.py: Used to compare beam search translation output with expected target results. See steps above for example.
 * runs/seq2seq/run.sh: Sets up and runs preprocess and training scripts.
 * runs/seq2seq/preprocess.sh: Uses OpenNMT preprocess to prepare training data including source and target vocabularies.
 * runs/seq2seq/train.sh: Runs training using bidirectional LSMT model on sequence-to-sequence data.
 * runs/seq2seq/translate12510.sh: Runs translation on src-test.txt data with beam widths of 1,2,5, and 10.
 * runs/graph2seq/run.sh: Sets up and runs preprocess and training scripts.
 * runs/graph2seq/preprocess.sh: Uses OpenNMT preprocess to prepare training data using srcvocab.txt and tgtvocab.txt.
 * runs/graph2seq/train.sh: Runs training using GGNN model on graph-to-sequence data.
 * runs/graph2seq/translate12510.sh: Runs translation on src-test.txt data with beam widths of 1,2,5, and 10.

### Key generated file descriptions
 * data/raw_initial.txt: 10 example programs generated using ANTLR. The format per lise is "X program Y target", where Y is the target output to be generated, in this case the algorithm's filename.
 * data/graph_initial.txt: 10 example programs in OpenNMT ggnn graph input format. The format per lise is "X program Y target", where Y is the target output to be generated, in this case the algorithm's filename. The program syntax is as per https://github.com/OpenNMT/OpenNMT-py/blob/master/docs/source/ggnn.md
 * runs/graph2seq/*vocab.txt: Files generated by setupgraph2seq.sh for use by graph neural network in OpenNMT. Note srcvocab.txt includes tokens for all node numbers to allow for proper edge connection setup for the model.
